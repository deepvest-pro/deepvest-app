# Интеграция с Xsolla Pay Station для Приема Фиатных Платежей в DeepVest Crowdfunding

## 1. Концепция и Ценность

Интеграция с Xsolla Pay Station позволит инвесторам DeepVest пополнять свой баланс на платформе или напрямую инвестировать в краудфандинговые кампании с использованием традиционных фиатных методов оплаты (банковские карты, PayPal и т.д.). Это значительно снижает порог входа для инвесторов, не знакомых с криптовалютами, и расширяет потенциальную аудиторию. Xsolla берет на себя процессинг фиатных платежей, KYC/AML и конвертацию средств в стейблкоины (например, USDC), которые затем могут быть использованы для инвестиций через смарт-контракты на Neon EVM.

**Ценность для DeepVest:**

- **Расширение Аудитории:** Привлечение инвесторов, предпочитающих фиатные платежи.
- **Упрощение Инвестирования:** Снижение барьеров для пользователей, не имеющих криптокошельков или опыта работы с криптовалютами.
- **Повышение Объемов Инвестиций:** Потенциальное увеличение общего объема привлекаемых средств за счет доступности фиатных опций.
- **Делегирование KYC/AML:** Xsolla может взять на себя часть процедур по верификации пользователей, оплачивающих фиатом.

## 2. Упрощенная Реализация/Имитация для Хакатона

Полноценная интеграция с Xsolla Pay Station, включая обработку вебхуков, управление каталогом товаров (инвестиционных пакетов) и автоматическую конвертацию в крипто, требует значительного времени и доступа к API Xsolla с возможностью настройки. Для хакатона предлагается следующая упрощенная схема, фокусирующаяся на UI/UX и имитации ключевых шагов:

**Сценарий для демонстрации:**

1.  **UI для "Покупки" Инвестиционного Пакета через Xsolla:**

    - На странице инвестирования в этап кампании, рядом с опцией "Инвестировать через криптокошелек (USDC)", добавляется кнопка "Инвестировать с помощью карты/PayPal (через Xsolla)".
    - При нажатии на эту кнопку инвестор указывает желаемую сумму инвестиции в USD.
    - Вместо реального открытия виджета Xsolla Pay Station (что требует настройки проекта в Xsolla Publisher Account и генерации токена), отображается **мок-страница (или модальное окно)**, имитирующая интерфейс Xsolla.
    - На этой мок-странице могут быть показаны логотипы платежных систем (Visa, Mastercard, PayPal), поля для ввода данных карты (неактивные) и кнопка "Оплатить".

2.  **Имитация Успешной Оплаты и Конвертации:**

    - После "оплаты" на мок-странице Xsolla, система DeepVest (бэкенд) **имитирует получение уведомления** об успешном фиатном платеже от Xsolla.
      - Это можно сделать через специальную кнопку на стороне администратора/демонстратора ("Имитировать успешный платеж от Xsolla на $X") или тайм-аут.
    - Бэкенд DeepVest **имитирует процесс конвертации** этой фиатной суммы в USDC (например, по курсу 1:1 минус фиктивная комиссия Xsolla, если это нужно показать).

3.  **Зачисление USDC на "Внутренний Баланс" или Прямое Инвестирование:**

    - **Вариант А (Внутренний баланс - проще для MVP):** "Конвертированные" USDC зачисляются на _внутренний счет (баланс)_ пользователя в системе DeepVest. Этот баланс хранится в БД Supabase (`user_profiles.fiat_usdc_balance`).
      - Далее, пользователь может использовать этот внутренний баланс для инвестирования в этап, инициируя уже стандартную транзакцию перевода USDC со специального "горячего" кошелька DeepVest на эскроу-контракт этапа. Этот кошелек должен управляться бэкендом.
    - **Вариант Б (Прямое инвестирование - сложнее):** Бэкенд DeepVest, получив подтверждение от "Xsolla" и "сконвертировав" средства, от имени пользователя (или от имени казначейского кошелька DeepVest) напрямую инвестирует соответствующую сумму в USDC в эскроу-контракт этапа. Это требует, чтобы у DeepVest был операционный кошелек с USDC и приватный ключ для подписания транзакций.

4.  **Обновление Статусов и UI:**
    - В таблице `milestone_investments` создается запись об инвестиции, где указывается `payment_method = 'xsolla_fiat'`, а `transaction_hash` может быть либо внутренним идентификатором операции, либо пустым, если реальной крипто-транзакции от имени пользователя не было (в случае Варианта А до момента траты с внутреннего баланса).
    - Пользователь видит свою инвестицию в личном кабинете и на странице кампании.

**Ключевые моменты для имитации:**

- **Отсутствие реальных платежей:** Никакие реальные деньги через Xsolla не проходят.
- **Фокус на потоке пользователя:** Демонстрация того, как пользователь мог бы оплатить фиатом.
- **Имитация вебхуков:** Подтверждение оплаты имитируется на стороне бэкенда.

## 3. Что можно реализовать на хакатоне (MVP)

1.  **Frontend (UI/UX):**

    - Кнопка "Инвестировать с помощью карты/PayPal (через Xsolla)" на странице этапа кампании.
    - Мок-страница/модальное окно, имитирующее Xsolla Pay Station (поля ввода неактивны, просто для вида).
    - Отображение "внутреннего USDC баланса" пользователя в его профиле (если выбран Вариант А).
    - Возможность "потратить" внутренний баланс на инвестицию.

2.  **Backend (Supabase):**

    - RPC-функция для "имитации успешного платежа Xsolla": принимает `user_id`, `amount_usd`. Эта функция:
      - Создает или обновляет запись в новой таблице `xsolla_transactions` (см. ниже).
      - (Для Варианта А) Обновляет `user_profiles.fiat_usdc_balance`.
      - (Для Варианта Б) Инициирует имитацию или реальный (если есть горячий кошелек) перевод USDC на эскроу-контракт.
    - Модификация логики инвестирования для поддержки платежей с "внутреннего баланса" (для Варианта А).
    - (Опционально) Простая админ-кнопка для триггера "успешного платежа Xsolla".

3.  **Новая таблица `xsolla_transactions` (для учета имитированных операций):**
    - `id`: UUID, PK
    - `user_id`: UUID, FK к `auth.users`
    - `milestone_investment_id`: UUID, NULLABLE, FK к `milestone_investments` (если платеж привязан к конкретной инвестиции)
    - `amount_usd_requested`: NUMERIC(12,2), сумма, которую пользователь "хотел" оплатить.
    - `status`: ENUM ('pending_mock_payment', 'mock_payment_successful', 'mock_payment_failed', 'funds_converted_to_usdc', 'invested_from_balance')
    - `mock_xsolla_transaction_id`: TEXT, (например, `mock_xsolla_ + random_string`)
    - `converted_usdc_amount`: NUMERIC(12,2), NULLABLE, сколько USDC было "получено".
    - `created_at`, `updated_at`: TIMESTAMPS

## 4. Ожидаемое время на реализацию MVP

- **Frontend (UI моки, логика внутреннего баланса):** 3-5 часов.
- **Backend (RPC для имитации, таблица `xsolla_transactions`, логика внутреннего баланса):** 3-4 часа.
- **Интеграция и тестирование сценария:** 1-2 часа.

**Итого:** Примерно **7-11 часов** для команды из 1-2 разработчиков.

## 5. Преимущества и Упрощения для Хакатона

- **Наглядность:** Демонстрирует возможность фиатных платежей без сложной интеграции.
- **Фокус на UX:** Позволяет проработать пользовательский путь.
- **Минимальные внешние зависимости:** Не требуется реальный аккаунт Xsolla или настройка их API для демо.
- **Быстрая реализация:** Имитация значительно проще полной интеграции.

## 6. Дальнейшее развитие (Post-Hackathon)

- **Реальная интеграция с Xsolla Pay Station API:**
  - Получение токена доступа для открытия виджета Pay Station.
  - Настройка каталога товаров (инвестиционных пакетов) в Xsolla Publisher Account.
  - Обработка реальных вебхуков от Xsolla для подтверждения платежей.
- **Автоматическая конвертация фиата в USDC:** Через сервисы Xsolla или партнерские обменники.
- **Управление казначейским кошельком DeepVest:** Для пополнения USDC и отправки их на эскроу-контракты.
- **Полная синхронизация KYC/AML:** Между DeepVest и Xsolla.
- **Обработка возвратов фиатных средств:** Через API Xsolla.

Таким образом, на хакатоне можно эффективно сымитировать использование Xsolla для приема фиатных платежей, чтобы донести идею и показать ее значимость для расширения доступности платформы DeepVest.
