# DeepVest Crowdfunding

## 1. Общая концепция и цели

Интегрировать в DeepVest платформу для этапного краудфандинга (milestone-based equity crowdfunding). Это позволит стартапам привлекать начальный капитал от сообщества и микро-инвесторов до проведения классических раундов финансирования. Инвесторы получат прозрачные условия и возможность вкладывать средства на разных этапах развития проекта, получая долю в компании (equity), размер которой зависит от стадии входа и суммы инвестиций. Чем раньше стадия, тем большую долю получает инвестор за каждый вложенный доллар.

**Основные цели:**

- Предоставить стартапам гибкий инструмент для поэтапного привлечения средств.
- Дать инвесторам доступ к ранним стадиям перспективных проектов с низким порогом входа.
- Обеспечить прозрачность процесса сбора и распределения средств, а также автоматические гарантии возврата средств в случае неудачи этапа, используя смарт-контракты.
- Повысить вовлеченность пользователей DeepVest, расширить поток стартапов и создать новый источник дохода для платформы.

## 2. Ключевые компоненты и бизнес-логика

### 2.1. Краудфандинговая Кампания (Crowdfunding Campaign)

1.  **Создание Кампании:**

    - Стартап (владелец проекта в DeepVest) инициирует создание "Краудфандинговой Кампании".
    - Определяет `total_equity_offered_percent` – максимальный процент эквити компании, который будет распределен между инвесторами в рамках всей кампании (например, 20%). Рекомендуется не более 30%.
    - Определяет `min_investment_usd` для всей кампании (например, 10 USDC). Стартап может переопределить это значение по умолчанию.
    - Кампания получает статус (`draft`, `active`, `successful`, `partially_successful`, `failed`, `cancelled`).

2.  **Этапы Кампании (Campaign Milestones):**
    - Стартап определяет от 1 до N (например, максимум 5) последовательных этапов (мейлстоунов) для своей кампании.
    - Для каждого этапа указываются:
      - `title` (название этапа): краткое и ясное (например, "Разработка MVP", "Маркетинговое исследование").
      - `description` (описание целей этапа): что конкретно будет достигнуто.
      - `min_target_amount_usd` (минимальная целевая сумма этапа): минимально необходимая сумма для реализации этапа.
      - `max_target_amount_usd` (максимальная целевая сумма этапа): желаемая максимальная сумма для полной реализации этапа.
      - `equity_for_milestone_percent` (процент эквити за этап): процент от _общего эквити компании_, выделяемый инвесторам, успешно профинансировавшим _именно этот_ этап. Сумма всех `equity_for_milestone_percent` по всем этапам не должна превышать `total_equity_offered_percent`.
      - `early_bird_multiplier` (множитель ранних вложений, опционально): коэффициент (например, 1.2), увеличивающий долю для инвесторов, вложившихся на ранней стадии сбора средств для данного этапа (например, для первых 30% собранной суммы).
      - `deadline` (крайний срок сбора): дата, до которой должны быть собраны средства на этап.
      - `expected_completion_date` (ожидаемая дата завершения работ): планируемая дата выполнения работ по этапу.
      - `order` (порядковый номер): последовательность этапа в кампании.
    - Статусы этапа: `pending` (ожидание), `active` (идет сбор), `funded` (средства собраны), `failed_to_fund` (сбор не удался), `in_progress_work` (работы в процессе), `review` (ожидает проверки модератором), `completed_work` (работы завершены и подтверждены), `cancelled` (отменен).

### 2.2. Механика Кампании и Финансирования

1.  **Активация Этапа:**

    - Первый этап (`order = 1`) становится `active` после публикации кампании.
    - Последующие этапы активируются (`status = 'active'`) только после того, как предыдущий этап успешно профинансирован (`status = 'funded'`) **И** работы по нему завершены и подтверждены модератором (`status = 'completed_work'`).

2.  **Инвестирование:**

    - Инвесторы видят активные этапы и могут вкладывать средства.
    - Все расчеты и инвестиции производятся в стейблкоинах (например, USDC) с отображением эквивалента в USD.
    - Инвестор может вложить любую сумму, не менее `min_investment_usd` этапа и не более доступного остатка до `max_target_amount_usd` этапа.
    - Средства инвесторов помещаются на эскроу-смарт-контракт до момента определения исхода этапа.

3.  **Завершение Этапа Сбора Средств:**

    - **Автоматический успех:** Если собрана сумма `current_amount_usd` >= `max_target_amount_usd`, этап автоматически завершается как успешно профинансированный (`funded`), независимо от `deadline`.
    - **Условный успех:** Если к `deadline` собрана сумма `min_target_amount_usd` <= `current_amount_usd` < `max_target_amount_usd`, этап считается успешно профинансированным (`funded`).
    - **Неуспех (`failed_to_fund`):** Если к `deadline` собрана сумма `current_amount_usd` < `min_target_amount_usd`, этап считается проваленным. Инвесторы получают возможность вернуть свои вложенные средства из эскроу-контракта (через функцию `claimRefund()`).

4.  **Завершение Работ по Этапу:**

    - Стартап выполняет заявленные работы.
    - Предоставляет доказательства выполнения (загрузка файлов, ссылок через специальный интерфейс).
    - Инициирует запрос на проверку выполнения этапа (`milestone_verification_request`). Статус этапа меняется на `review`.
    - **Модератор DeepVest** проверяет предоставленные доказательства (SLA на проверку – например, 24 часа).
      - Если работы выполнены: модератор подтверждает, статус этапа меняется на `completed_work`. Это может триггеровать активацию следующего этапа. Средства с эскроу-контракта (за вычетом комиссии DeepVest) переводятся стартапу. Инвесторам начисляется их доля эквити (в виде записей в БД/контракте).
      - Если работы не выполнены или выполнены некачественно: модератор отклоняет, стартас этапа может вернуться в `in_progress_work` или, в крайнем случае, `failed` (если исправить невозможно), что также приведет к возврату средств инвесторам.

5.  **Отмена Кампании/Этапа:**

    - Стартап **не может** отменить _активный_ (идет сбор средств, `status = 'active'`) или _успешно профинансированный_ (`status = 'funded'`, `status = 'in_progress_work'`) этап.
    - Стартап **может** отменить _будущие, еще не активные_ этапы (`status = 'pending'`) без штрафных санкций, если это не влияет на уже профинансированные и завершенные этапы.
    - Модератор DeepVest **может** отменить любой этап по уважительной причине (мошенничество, нарушение правил платформы, технические проблемы).
      - Если этап отменен модератором до перевода средств стартапу (например, в статусах `active` или `funded` до подтверждения работ), инвесторам возвращаются их вложения.
    - Для отмены всей кампании, если есть активный или профинансированный этап, также требуется вмешательство и одобрение модератора DeepVest.

6.  **Частичный Успех Кампании:**
    - Если часть этапов успешно профинансирована и выполнена, а последующий этап не собрал средства или был правомерно отменен стартапом (будучи в статусе `pending`), инвесторы успешно завершенных этапов сохраняют свои доли. Средства за неуспешный или отмененный (если он был активен и отменен модератором) этап возвращаются инвесторам.

### 2.3. Расчет Долей и Финансовые Потоки

**Принцип:** Стартап определяет `equity_for_milestone_percent` для каждого этапа. Эффект "большей доли за доллар на ранних этапах" достигается путем установки более высокого `equity_for_milestone_percent` по отношению к `target_amount_usd` для ранних этапов.

**Формула расчета доли инвестора от конкретного этапа:**

`InvestorShareFromMilestone = (InvestorContributionToMilestone / TotalCollectedForMilestone) * MilestoneEquityOfferedPercent * [EarlyBirdMultiplier]`

Где:

- `InvestorContributionToMilestone` (сумма инвестиции инвестора на этапе) – вклад конкретного инвестора в данный этап.
- `TotalCollectedForMilestone` (фактически собранная сумма на этапе) – общая сумма, собранная на данном этапе (между `min_target_amount_usd` и `max_target_amount_usd`).
- `MilestoneEquityOfferedPercent` (процент эквити за этап) – процент от _общего эквити компании_, выделенный на данный этап.
- `EarlyBirdMultiplier` (множитель ранних вложений, если применяется) – бонус для ранних инвесторов данного этапа.

**Примечание:** Доля рассчитывается пропорционально от фактически собранной суммы, что означает, что если этап собрал меньше максимальной суммы, инвесторы получат большую долю за каждый вложенный доллар.

**Пример:**

- Кампания: 20% эквити за 3 этапа.
- Этап 1: Минимум $3000, максимум $5000, `equity_for_milestone_percent` 10%, `early_bird_multiplier` 1.5 (для первых 30% сбора).
  - Допустим, этап собрал $4000 (между минимумом и максимумом).
  - Инвестор А вложил $100 (входит в первые 30% сбора).
    Доля А = ($100 / $4000) _ 10% _ 1.5 = 0.025 _ 10% _ 1.5 = 0.0375% компании.
  - Инвестор Б вложил $100 (после первых 30% сбора).
    Доля Б = ($100 / $4000) _ 10% _ 1.0 = 0.025 \* 10% = 0.025% компании.
- Этап 2: Минимум $15000, максимум $20000, `equity_for_milestone_percent` 7%.
- Этап 3: Минимум $80000, максимум $100000, `equity_for_milestone_percent` 3%.

### 2.4. Комиссии Платформы DeepVest

- **Комиссия с эквити:** `0.1%` от `equity_for_milestone_percent` (т.е. от доли компании, выделенной на успешно завершенный этап). Эта часть эквити отходит DeepVest.
- **Комиссия со средств:** `1%` от фактически собранной суммы (`current_amount_usd`) на успешно завершенном этапе. Эта сумма удерживается из средств, переводимых стартапу.

Комиссии взимаются автоматически при успешном завершении этапа и переводе средств стартапу.

## 3. Структура Данных (Supabase)

### Таблица `crowdfunding_campaigns` (Краудфандинговые Кампании)

- `id`: UUID, PK
- `project_id`: UUID, FK к `projects` (уникальный для каждого проекта, т.е. один проект - одна активная кампания)
- `title`: TEXT, название кампании
- `description`: TEXT, описание кампании
- `total_equity_offered_percent`: NUMERIC(5,2), общий процент эквити, предлагаемый инвесторам за всю кампанию.
- `min_investment_usd`: NUMERIC(10,2), DEFAULT 10.00, минимальная сумма инвестиции для участия в кампании.
- `status`: ENUM ('draft', 'active', 'successful', 'partially_successful', 'failed', 'cancelled')
- `contract_address`: TEXT, NULLABLE, адрес основного контракта кампании (если есть).
- `moderator_id`: UUID, NULLABLE, FK к `auth.users` (ответственный модератор).
- `max_milestones_allowed`: INTEGER, DEFAULT 5.
- `created_at`, `updated_at`: TIMESTAMPS

### Таблица `campaign_milestones` (Этапы Кампании)

- `id`: UUID, PK
- `campaign_id`: UUID, FK к `crowdfunding_campaigns`
- `order_index`: INTEGER, порядковый номер этапа (1, 2, 3...).
- `name`: TEXT, название этапа (например, "Разработка MVP").
- `description`: TEXT, описание целей этапа.
- `min_target_amount_usd`: NUMERIC(12,2), минимальная целевая сумма для этапа.
- `max_target_amount_usd`: NUMERIC(12,2), максимальная целевая сумма для этапа.
- `current_amount_usd`: NUMERIC(12,2), DEFAULT 0, текущая собранная сумма.
- `equity_for_milestone_percent`: NUMERIC(5,2), процент эквити от _общего эквити компании_, выделяемый на данный этап.
- `early_bird_multiplier`: NUMERIC(3,2), DEFAULT 1.0, множитель для ранних инвесторов.
- `early_bird_threshold_percent`: NUMERIC(5,2), DEFAULT 30.00, порог (в % от `max_target_amount_usd`) для применения `early_bird_multiplier`.
- `deadline`: TIMESTAMP, дата окончания сбора на этап.
- `expected_completion_date`: TIMESTAMP, NULLABLE, ожидаемая дата завершения работ по этапу.
- `status`: ENUM ('pending', 'active', 'funded', 'failed_to_fund', 'in_progress_work', 'review', 'completed_work', 'cancelled')
- `blockchain_escrow_address`: TEXT, NULLABLE, адрес эскроу-контракта для этапа.
- `tx_id_funding_release`: TEXT, NULLABLE, хэш транзакции вывода средств стартапу.
- `completed_at`: TIMESTAMP, NULLABLE, фактическая дата завершения работ.
- `cancelled_at`: TIMESTAMP, NULLABLE, дата отмены этапа.
- `cancellation_reason`: TEXT, NULLABLE, причина отмены.
- `moderator_notes`: TEXT, NULLABLE, заметки модератора по этапу.
- `created_at`, `updated_at`: TIMESTAMPS

### Таблица `milestone_investments` (Инвестиции в Этапы)

- `id`: UUID, PK
- `campaign_milestone_id`: UUID, FK к `campaign_milestones`
- `user_id`: UUID, FK к `auth.users` (инвестор)
- `amount_usd`: NUMERIC(12,2), сумма инвестиции в USD-эквиваленте.
- `amount_stablecoin`: NUMERIC(18,6), сумма инвестиции в стейблкоинах (например, USDC).
- `stablecoin_type`: TEXT, DEFAULT 'USDC'.
- `calculated_equity_percentage`: NUMERIC(10,8), рассчитанный процент эквити компании, полученный за эту инвестицию.
- `equity_tokens_representation`: NUMERIC(18,8), NULLABLE, условное количество "токенов" или "юнитов", представляющих долю (для UI).
- `transaction_hash`: TEXT, хэш транзакции инвестирования.
- `status`: ENUM ('pending_payment', 'confirmed', 'failed_payment', 'refund_requested', 'refunded')
- `is_early_bird`: BOOLEAN, DEFAULT FALSE, была ли инвестиция сделана в период действия `early_bird_multiplier`.
- `is_public`: BOOLEAN, DEFAULT TRUE, может ли инвестор скрыть свое имя (вместо имени будет "Инвестор #XYZ").
- `public_alias`: TEXT, NULLABLE, псевдоним для скрытого инвестора.
- `invested_at`: TIMESTAMP, DEFAULT NOW()
- `refund_transaction_hash`: TEXT, NULLABLE, хэш транзакции возврата.
- `created_at`, `updated_at`: TIMESTAMPS

### Таблица `milestone_proofs` (Доказательства Выполнения Этапа)

- `id`: UUID, PK
- `campaign_milestone_id`: UUID, FK к `campaign_milestones`
- `uploaded_by_user_id`: UUID, FK к `auth.users` (кто загрузил, обычно основатель).
- `proof_type`: ENUM ('file', 'link', 'text_description')
- `content_url`: TEXT, NULLABLE, URL файла (если `proof_type = 'file'`, ссылка на Supabase Storage) или внешняя ссылка (если `proof_type = 'link'`).
- `description`: TEXT, NULLABLE, текстовое описание или содержимое (если `proof_type = 'text_description'`).
- `original_file_name`: TEXT, NULLABLE.
- `mime_type`: TEXT, NULLABLE.
- `created_at`: TIMESTAMP, DEFAULT NOW()

### Таблица `milestone_verification_requests` (Запросы на Проверку Выполнения Этапа)

- `id`: UUID, PK
- `campaign_milestone_id`: UUID, FK к `campaign_milestones` (уникальный для каждого этапа)
- `requested_by_user_id`: UUID, FK к `auth.users` (кто запросил, обычно основатель).
- `status`: ENUM ('pending', 'approved', 'rejected', 'more_info_requested')
- `moderator_id`: UUID, NULLABLE, FK к `auth.users` (кто обработал).
- `moderator_comment`: TEXT, NULLABLE, комментарий модератора.
- `requested_at`: TIMESTAMP, DEFAULT NOW()
- `expires_at`: TIMESTAMP, NULLABLE (SLA на проверку, например, `requested_at + 24 hours`).
- `updated_at`: TIMESTAMP

### Таблица `deepvest_fees_collected` (Собранные Комиссии DeepVest)

- `id`: UUID, PK
- `campaign_milestone_id`: UUID, FK к `campaign_milestones`
- `fee_type`: ENUM ('equity_fee', 'funds_transfer_fee')
- `amount_collected_percent`: NUMERIC(5,2), NULLABLE (для `equity_fee`, процент от эквити этапа).
- `amount_collected_usd`: NUMERIC(12,2), NULLABLE (для `funds_transfer_fee`, сумма в USD).
- `transaction_hash_related`: TEXT, NULLABLE (связанная транзакция, например, перевод средств стартапу).
- `collected_at`: TIMESTAMP, DEFAULT NOW()

_Примечание: Все суммы хранятся в USD-эквиваленте для единообразия. Фактические транзакции на блокчейне будут в стейблкоинах (например, USDC). Поля `amount_stablecoin` и `stablecoin_type` добавлены для фиксации деталей транзакции._

## 4. Архитектура Смарт-Контракта (MVP на Neon EVM)

Для MVP и хакатона предлагается простой смарт-контракт для каждого этапа кампании, действующий как эскроу.

### Спонсоры и Технологии:

- **Neon EVM**: Основная платформа для развертывания смарт-контрактов. Позволяет использовать Solidity и экосистему Ethereum (например, Hardhat, OpenZeppelin) на Solana, обеспечивая низкие комиссии и высокую скорость.
- **Civic (Опционально для MVP, но рекомендовано для продакшена):** Для KYC/AML верификации инвесторов и основателей. Может быть интегрирован на уровне UI перед взаимодействием с контрактом. Для MVP хакатона KYC можно опустить.
- **Chainlink (Опционально для MVP):** Если бы принимались нестейблкоины, Chainlink Price Feeds использовались бы для конвертации в USD. Поскольку решено использовать USDC, прямая необходимость в Price Feeds для MVP отпадает, но может быть полезна для отображения эквивалентов в других валютах или для будущих расширений.
- **Xsolla (Опционально, за рамками MVP хакатона):** Для приема фиатных платежей и их конвертации в USDC для последующего инвестирования через смарт-контракт.

### Смарт-Контракт `MilestoneEscrow.sol` (для каждого этапа)

- **Переменные Состояния:**

  - `address public startupWallet`: Адрес кошелька стартапа.
  - `address public deepvestModerator`: Адрес модератора DeepVest (или мультисиг-кошелька).
  - `address public deepvestTreasury`: Адрес кошелька DeepVest для сбора комиссий.
  - `IERC20 public usdcToken`: Адрес контракта USDC.
  - `uint256 public minTargetAmountUSDC`: Минимальная целевая сумма сбора в USDC.
  - `uint256 public maxTargetAmountUSDC`: Максимальная целевая сумма сбора в USDC.
  - `uint256 public collectedAmountUSDC`: Текущая собранная сумма.
  - `uint256 public deadlineTimestamp`: Дедлайн для сбора средств.
  - `enum Status { Funding, Funded, WorkCompleted, Failed, Cancelled, FundsReleased, Refunding }`: Статус контракта.
  - `Status public currentStatus`: Текущий статус.
  - `mapping(address => uint256) public contributions`: Суммы вкладов инвесторов.
  - `mapping(address => bool) public hasClaimedRefund`: Флаг, показывающий, вернул ли инвестор средства.
  - `uint16 public constant PLATFORM_FUNDS_FEE_BP = 100; // 1% (100 базисных пунктов)`

- **Основные Функции:**

  - `constructor(address _startupWallet, address _moderator, address _treasury, address _usdcToken, uint256 _minTargetAmount, uint256 _maxTargetAmount, uint256 _deadline)`: Инициализация контракта.
  - `invest(uint256 _amountUSDC)`:
    - Проверяет, что `currentStatus == Status.Funding` и `block.timestamp < deadlineTimestamp`.
    - Проверяет, что `_amountUSDC >= MINIMUM_INVESTMENT_CONTRACT` (минимальная сумма может быть установлена в контракте или передана в конструктор).
    - Проверяет, что `collectedAmountUSDC + _amountUSDC <= maxTargetAmountUSDC`.
    - Переводит `_amountUSDC` с кошелька инвестора (`msg.sender`) на адрес контракта.
    - Обновляет `contributions[msg.sender]` и `collectedAmountUSDC`.
    - Если `collectedAmountUSDC >= maxTargetAmountUSDC`, меняет `currentStatus = Status.Funded` (автоматическое завершение).
    - Генерирует событие `InvestmentMade(address indexed investor, uint256 amount)`.
  - `requestWorkCompletionApproval()`: (вызывается стартапом `startupWallet` или авторизованным бэкендом)
    - Проверяет, что `currentStatus == Status.Funded`.
    - Сигнализирует бэкенду (через событие или прямое ожидание), что нужно начать процесс верификации модератором.
    - Генерирует событие `WorkCompletionApprovalRequested()`.
  - `confirmWorkCompletion(bool _isApproved)`: (вызывается модератором `deepvestModerator`)
    - Проверяет, что `currentStatus == Status.Funded` (или специальный статус "ожидание проверки").
    - Если `_isApproved == true`:
      - Меняет `currentStatus = Status.WorkCompleted`.
      - Инициирует перевод средств:
        - `uint256 feeAmount = (collectedAmountUSDC * PLATFORM_FUNDS_FEE_BP) / 10000;`
        - `uint256 netAmountToStartup = collectedAmountUSDC - feeAmount;`
        - `usdcToken.transfer(deepvestTreasury, feeAmount);`
        - `usdcToken.transfer(startupWallet, netAmountToStartup);`
        - Меняет `currentStatus = Status.FundsReleased`.
      - Генерирует событие `WorkCompletedAndFundsReleased(uint256 amountToStartup, uint256 feeToTreasury)`.
    - Если `_isApproved == false`:
      - Этап считается проваленным (логика обработки должна быть на бэкенде, возможно изменение статуса на `Failed` и начало возврата).
      - Генерирует событие `WorkCompletionRejected()`.
  - `handleFailedFunding()`: (может вызываться кем угодно после `deadlineTimestamp`, если `minTargetAmountUSDC` не достигнут, или модератором)
    - Проверяет, что `block.timestamp >= deadlineTimestamp` и `collectedAmountUSDC < minTargetAmountUSDC`, ИЛИ что вызов от модератора.
    - Меняет `currentStatus = Status.Refunding` (или `Status.Failed` если модератор).
    - Генерирует событие `FundingFailed()`.
  - `moderatorCancelMilestone()`: (вызывается модератором `deepvestModerator`)
    - Меняет `currentStatus = Status.Cancelled`.
    - Инициирует процесс возврата средств (если они были собраны), меняя статус на `Status.Refunding`.
    - Генерирует событие `MilestoneCancelledByModerator()`.
  - `claimRefund()`: (вызывается инвестором `msg.sender`)
    - Проверяет, что `currentStatus == Status.Refunding` (или `Failed`, `Cancelled` если средства на контракте).
    - Проверяет, что `contributions[msg.sender] > 0` и `!hasClaimedRefund[msg.sender]`.
    - Переводит `contributions[msg.sender]` обратно инвестору.
    - Устанавливает `hasClaimedRefund[msg.sender] = true`.
    - Генерирует событие `RefundClaimed(address indexed investor, uint256 amount)`.

- **Токены Эквити:** Для MVP хакатона фактический минтинг токенов ERC-20 или NFT не обязателен. Записи о долях (`calculated_equity_percentage` в таблице `milestone_investments`) и информация о вкладах в смарт-контракте будут достаточны. "Equity tokens" в UI могут быть просто числовым представлением этой доли.

- **Управление:**
  - DeepVest (бэкенд) деплоит новый экземпляр контракта `MilestoneEscrow` для каждого этапа кампании. Адрес контракта сохраняется в `campaign_milestones.blockchain_escrow_address`.
  - Бэкенд слушает события от смарт-контрактов для обновления статусов в базе данных.

**Упрощения для хакатона:**

- Минимальная проверка безопасности.
- Стартап и модератор могут быть представлены обычными адресами кошельков.
- Фокус на основной логике: сбор, удержание, перевод стартапу при успехе, возврат при неудаче/отмене.
- Расчет долей эквити происходит оффчейн (в бэкенде) и записывается в БД. Смарт-контракт отвечает только за движение средств.

## 5. Пользовательские Сценарии (User Flow)

### Для Стартапа:

1.  **Вход и Навигация:** Заходит в свой проект на DeepVest, находит раздел "Краудфандинг".
2.  **Создание Кампании:**
    - Нажимает "Создать новую кампанию".
    - Заполняет общую информацию: название, описание, `total_equity_offered_percent`, `min_investment_usd`.
3.  **Добавление Этапов (Мейлстоунов):**
    - Добавляет от 1 до N этапов. Для каждого указывает: название, описание, `min_target_amount_usd`, `max_target_amount_usd`, `equity_for_milestone_percent`, `early_bird_multiplier` (если есть), `deadline`, `expected_completion_date`.
    - Система проверяет, что сумма `equity_for_milestone_percent` по всем этапам не превышает `total_equity_offered_percent`.
4.  **Публикация:** Сохраняет кампанию как черновик (`draft`) или публикует (`active`). При публикации первый этап становится активным для сбора средств, бэкенд деплоит для него смарт-контракт `MilestoneEscrow`.
5.  **Отслеживание Прогресса:** На дашборде кампании видит прогресс сбора средств по текущему активному этапу.
6.  **Завершение Сбора и Начало Работ:**
    - При успешном сборе средств (`funded`) получает уведомление.
    - Приступает к выполнению работ по этапу, меняет статус на `in_progress_work`.
7.  **Подтверждение Выполнения Работ:**
    - После выполнения работ загружает доказательства (файлы, ссылки) через интерфейс.
    - Отправляет этап на проверку модератору (`review`).
8.  **Получение Средств / Активация Следующего Этапа:**
    - После подтверждения модератором (`completed_work`), средства с эскроу-контракта переводятся на кошелек стартапа (за вычетом комиссии).
    - Если есть следующий этап, он автоматически активируется для сбора средств (деплоится новый смарт-контракт).
9.  **Отмена Будущих Этапов:** При необходимости может отменить этапы со статусом `pending`.

### Для Инвестора:

1.  **Поиск и Просмотр Кампаний:** На платформе DeepVest просматривает список активных краудфандинговых кампаний. Использует фильтры.
2.  **Изучение Кампании:** Переходит на страницу детализации кампании. Изучает описание проекта, команду, AI-скоринг (если есть), условия кампании, информацию по этапам (цели с диапазоном минимум-максимум, предлагаемая доля, сроки).
3.  **Выбор Этапа и Инвестирование:**
    - Выбирает активный этап для инвестирования.
    - Подключает свой крипто-кошелек (например, MetaMask, настроенный для Neon EVM).
    - Проходит быструю KYC-проверку через Civic (если реализовано).
    - Вводит сумму инвестиции в USDC (не менее `min_investment_usd`).
    - Подтверждает транзакцию в кошельке.
4.  **Отслеживание Инвестиций:** В личном кабинете DeepVest видит свои инвестиции, их текущий статус и потенциальную долю эквити.
5.  **Отслеживание Прогресса Кампании:** Следит за статусом этапа, в который инвестировал, и кампании в целом. Получает уведомления о ключевых событиях (этап профинансирован, работы завершены, следующий этап начался, этап провален/отменен).
6.  **Возврат Средств:** В случае неудачи этапа сбора (`failed_to_fund`) или отмены этапа модератором (`cancelled`), если средства были на эскроу, инвестор может зайти в свой кабинет и инициировать возврат средств на свой кошелек (вызвав `claimRefund()` на смарт-контракте через интерфейс DeepVest).

## 6. Реализация для Хакатона (2 дня)

### День 1: Backend, Смарт-Контракты, Базовая Инфраструктура

- **Supabase:**
  - Создать все необходимые таблицы (`crowdfunding_campaigns`, `campaign_milestones`, `milestone_investments`, `milestone_proofs`, `milestone_verification_requests`, `deepvest_fees_collected`).
  - Настроить RLS (Row Level Security) для базовых сценариев доступа.
  - Написать основные CRUD функции (RPC) для управления кампаниями и этапами (создание, обновление статусов).
- **Смарт-Контракт (Solidity на Neon EVM):**
  - Разработать и протестировать (локально с Hardhat) смарт-контракт `MilestoneEscrow.sol` с основной логикой: `invest`, `confirmWorkCompletion` (упрощенный, без полного цикла сбора средств на кошельке, а просто смена статуса и логирование), `handleFailedFunding`/`moderatorCancelMilestone`, `claimRefund`.
  - Подготовить скрипт для деплоя контракта на Neon EVM Devnet.
- **Интеграция Backend <-> Смарт-Контракт:**
  - Настроить вызов функций смарт-контракта из бэкенда Supabase (через Edge Functions на TypeScript с ethers.js) для деплоя и, возможно, некоторых управляющих действий.
  - Реализовать простой механизм прослушивания событий от смарт-контракта (можно имитировать через периодический опрос состояния контракта для MVP, либо настроить webhook если Neon предоставляет такую возможность для Devnet).
- **API:**
  - Создать базовые API-эндпоинты для создания кампании стартапом и получения списка/деталей кампаний для инвесторов.

### День 2: Frontend, Интеграция, Демонстрация

- **Frontend (Next.js):**
  - **Для Стартапа:**
    - Форма создания/редактирования краудфандинговой кампании и ее этапов (упрощенная).
    - Дашборд для просмотра статуса своей кампании и этапов.
    - Элементарный интерфейс для "загрузки доказательств" и "запроса на проверку".
  - **Для Инвестора:**
    - Страница со списком активных кампаний.
    - Страница с деталями кампании и ее этапов.
    - Интерфейс для подключения кошелька (MetaMask для Neon EVM).
    - Форма для ввода суммы инвестиции и вызова функции `invest` смарт-контракта.
    - Отображение прогресс-баров сбора средств с индикацией минимального и максимального порогов, таймеров до дедлайна.
    - Кнопка "Вернуть средства" (активна, если этап провален/отменен).
- **Интеграция Frontend <-> Backend <-> Смарт-Контракт:**
  - Связать UI с API Supabase.
  - Обеспечить взаимодействие UI с кошельком и смарт-контрактами.
- **Демо-Сценарий:**
  - Подготовить тестовый проект и краудфандинговую кампанию с несколькими этапами.
  - Продемонстрировать процесс создания кампании стартапом.
  - Продемонстрировать процесс инвестирования от имени инвестора.
  - Показать, как меняются статусы, как средства "собираются" (на уровне UI и, возможно, на смарт-контракте в Devnet).
  - Сымитировать успешное завершение этапа (модератором через UI или напрямую бэкендом).
  - Сымитировать провал этапа и показать возможность возврата средств.
  - Объяснить, что расчет долей эквити и их "выдача" (как учетных записей) происходит на бэкенде, а смарт-контракт управляет финансами.

**Без чего можно обойтись на хакатоне (если не хватит времени):**

- Реальная KYC-интеграция с Civic (достаточно заглушки).
- Сложные расчеты эквити с `early_bird_multiplier` в UI (можно показать базовый расчет).
- Детальная админ-панель для модератора.
- Email/Push уведомления.
- Автоматическая активация следующего этапа после завершения предыдущего (можно сделать вручную модератором/бэкендом).

## 7. Потенциал для коммерческого использования и дальнейшего развития

- **Юридическая обвязка:** Автоматическая генерация SAFE, KISS или других релевантных документов для инвесторов.
- **Полноценные Токены Эквити:** Минтинг ERC-20 или NFT токенов, представляющих долю инвестора, с возможностью их передачи и торговли.
- **Вторичный Рынок:** Интеграция с DEX или создание P2P площадки для торговли токенами эквити.
- **Углубленная Интеграция KYC/AML:** Обязательная верификация через Civic или другие сервисы.
- **Расширенные Модели Финансирования:** Поддержка Convertible Notes, SAFTs.
- **Система Голосования:** Предоставление инвесторам возможности голосовать по ключевым решениям стартапа (в зависимости от размера доли).
- **Интеграция с Chainlink Proof-of-Reserve:** Для подтверждения наличия средств на эскроу-счетах.
- **Автоматизированная Проверка Этапов:** Для некоторых типов этапов (например, связанных с кодом) можно интегрировать автоматические проверки (через Chainlink Functions или iExec).
- **Фиатный Шлюз:** Полная интеграция с Xsolla для приема фиатных платежей.
- **Мульти-сиг кошельки:** Для управления средствами на стороне DeepVest (модератор, казначейство).
- **Страхование Рисков:** Рассмотрение механизмов страхования для инвесторов.
- **Поддержка Других Блокчейнов:** Расширение на Polkadot, Flare, Oasis и др. для диверсификации и доступа к разным экосистемам.
- **Использование Origin Trail:** Для повышения прозрачности цепочки поставок и отчетности по использованию средств стартапами.

---
